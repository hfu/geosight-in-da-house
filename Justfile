# GeoSight in-da-house Justfile
# For Raspberry Pi OS trixie 64bit on Raspberry Pi 4B
# Based on knowledge from UNopenGIS/7 issue #821

# Default variables - optimized for Raspberry Pi 4B (4GB RAM)
GEOSIGHT_REPO := "https://github.com/unicef-drp/GeoSight-OS.git"
GEOSIGHT_DIR := "GeoSight-OS"
HTTP_PORT := "2000"
HTTPS_PORT := "2443"

# Raspberry Pi optimized settings
# These can be overridden with: just --set VARIABLE value
COMPOSE_HTTP_TIMEOUT := "300"
DOCKER_CLIENT_TIMEOUT := "300"

# Default recipe: show available commands
default:
    @just --list

# Install all required packages and clone GeoSight-OS
install:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "======================================"
    echo "  Installing GeoSight for Raspberry Pi"
    echo "======================================"
    echo ""
    
    # Update package lists
    echo "üì¶ Updating package lists..."
    sudo apt-get update
    
    # Install required packages
    echo "üì¶ Installing required packages..."
    sudo apt-get install -y \
        git \
        docker.io \
        docker-compose \
        curl \
        make
    
    # Enable and start Docker
    echo "üê≥ Enabling Docker service..."
    sudo systemctl enable docker
    sudo systemctl start docker
    
    # Add current user to docker group if not already
    if ! groups | grep -q docker; then
        echo "üë§ Adding user to docker group..."
        sudo usermod -aG docker $USER
        echo "‚ö†Ô∏è  Please log out and log back in for docker group to take effect"
        echo "   Then run: just install"
        exit 0
    fi
    
    # Clone GeoSight-OS if not exists
    if [ ! -d "{{GEOSIGHT_DIR}}" ]; then
        echo "üì• Cloning GeoSight-OS repository..."
        git clone {{GEOSIGHT_REPO}}
    else
        echo "‚úÖ GeoSight-OS directory already exists"
    fi
    
    # Run setup
    echo "üîß Running GeoSight setup..."
    cd {{GEOSIGHT_DIR}}
    
    # Create .env file with Raspberry Pi optimized settings
    if [ ! -f deployment/.env ]; then
        echo "üîß Creating deployment/.env with Raspberry Pi optimized settings..."
        cat > deployment/.env << 'ENVEOF'
# GeoSight configuration optimized for Raspberry Pi 4B
# Generated by geosight-in-da-house

# Security - Change this in production!
SECRET_KEY=geosight-raspberry-pi-secret-key-change-me

COMPOSE_PROJECT_NAME=geosight
NGINX_TAG=0.0.1
DJANGO_TAG=3.1.0

# Django settings
DJANGO_SETTINGS_MODULE=core.settings.prod
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin
ADMIN_EMAIL=admin@example.com
INITIAL_FIXTURES=True

# Port configuration - default 2000 for Raspberry Pi
HTTP_PORT=2000
HTTPS_PORT=2443

# Sentry - disabled by default
SENTRY_DSN=
SENTRY_ENVIRONMENT=development

# Redis configuration
REDIS_HOST=redis
REDIS_PASSWORD=redis_password

# Database configuration
DATABASE_NAME=django
DATABASE_USERNAME=docker
DATABASE_PASSWORD=docker
DATABASE_HOST=db
RABBITMQ_HOST=rabbitmq

# Azure B2C - disabled by default
AZURE_B2C_CLIENT_ID=
AZURE_B2C_CLIENT_SECRET=
AZURE_B2C_TENANT_NAME=
AZURE_B2C_POLICY_NAME=

# Email - disabled by default
EMAIL_HOST=
EMAIL_PORT=
EMAIL_HOST_USER=
EMAIL_HOST_PASSWORD=
EMAIL_USE_TLS=
EMAIL_USE_SSL=
DEFAULT_FROM_EMAIL=

# Log rotation - reduced for Raspberry Pi storage
LOGROTATE_COPIES=7
LOGROTATE_SIZE=50M
LOGROTATE_INTERVAL=daily

# App domain
APP_DOMAIN=localhost

# Plugins - minimal for Raspberry Pi
PLUGINS=cloud_native_gis,reference_dataset
ENVEOF
        echo "‚úÖ deployment/.env file created"
    else
        echo "‚úÖ deployment/.env already exists"
    fi
    
    # Create docker-compose override if not exists
    if [ ! -f deployment/docker-compose.override.yml ]; then
        echo "üîß Creating docker-compose.override.yml..."
        cp deployment/docker-compose.override.template.yml deployment/docker-compose.override.yml
        echo "‚úÖ docker-compose.override.yml created"
    else
        echo "‚úÖ docker-compose.override.yml already exists"
    fi
    
    # Pull required images for ARM64
    echo "üê≥ Pulling Docker images for ARM64..."
    ARCH=$(uname -m)
    PLATFORM="linux/amd64"
    [[ "$ARCH" == "arm64" || "$ARCH" == "aarch64" ]] && PLATFORM="linux/arm64"
    docker pull --platform=$PLATFORM ubuntu:22.04
    
    echo ""
    echo "======================================"
    echo "  Installation complete!"
    echo "======================================"
    echo ""
    echo "Next: Run 'just run' to start GeoSight"

# Run GeoSight in development mode
run:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "======================================"
    echo "  Starting GeoSight"
    echo "======================================"
    echo ""
    
    cd {{GEOSIGHT_DIR}}
    
    # Set Docker timeouts for Raspberry Pi
    export COMPOSE_HTTP_TIMEOUT={{COMPOSE_HTTP_TIMEOUT}}
    export DOCKER_CLIENT_TIMEOUT={{DOCKER_CLIENT_TIMEOUT}}
    
    # Create redis directory with correct permissions
    if [ ! -d deployment/volumes/tmp_data/redis ]; then
        echo "üìÅ Creating Redis directory..."
        sudo mkdir -p deployment/volumes/tmp_data/redis
        sudo chown -R 999:999 deployment/volumes/tmp_data/redis
    else
        sudo chown -R 999:999 deployment/volumes/tmp_data/redis
    fi
    
    # Run development mode
    echo "üöÄ Starting Docker containers (this may take a while on Raspberry Pi)..."
    make dev
    
    echo ""
    echo "‚è≥ Waiting for services to start..."
    sleep 30
    
    # Initialize the application
    echo "üîß Initializing GeoSight..."
    make dev-initialize
    
    # Load demo data
    echo "üìä Loading demo data..."
    make load-test-data
    
    echo ""
    echo "======================================"
    echo "  GeoSight is running!"
    echo "======================================"
    echo ""
    echo "Access GeoSight at: http://localhost:{{HTTP_PORT}}/"
    echo "Login: admin / admin"
    echo ""
    echo "To stop: just stop"

# Stop GeoSight
stop:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "üõë Stopping GeoSight..."
    cd {{GEOSIGHT_DIR}}
    make down
    echo "‚úÖ GeoSight stopped"

# Uninstall GeoSight (remove containers, images, and optionally the repository)
uninstall:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "======================================"
    echo "  Uninstalling GeoSight"
    echo "======================================"
    echo ""
    
    if [ -d "{{GEOSIGHT_DIR}}" ]; then
        cd {{GEOSIGHT_DIR}}
        
        # Stop and remove containers
        echo "üõë Stopping and removing containers..."
        make down || true
        
        # Remove Docker volumes
        echo "üóëÔ∏è  Removing Docker volumes..."
        docker volume rm geosight_static-data geosight_media-data geosight_database \
            geosight_backups-data geosight_rabbitmq geosight_redis-data \
            geosight_tmp-data geosight_tmp-logrotate 2>/dev/null || true
        
        cd ..
        
        # Ask about removing the repository
        read -p "Remove GeoSight-OS directory? [y/N] " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "üóëÔ∏è  Removing GeoSight-OS directory..."
            sudo rm -rf {{GEOSIGHT_DIR}}
        fi
    else
        echo "‚ö†Ô∏è  GeoSight-OS directory not found"
    fi
    
    echo ""
    echo "‚úÖ Uninstall complete"

# Create Cloudflare Tunnel for internet access
tunnel:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "======================================"
    echo "  Creating Cloudflare Tunnel"
    echo "======================================"
    echo ""
    
    # Check if cloudflared is installed
    if ! command -v cloudflared &> /dev/null; then
        echo "üì¶ Installing cloudflared..."
        
        # Detect architecture
        ARCH=$(uname -m)
        if [[ "$ARCH" == "aarch64" || "$ARCH" == "arm64" ]]; then
            CLOUDFLARED_ARCH="arm64"
        else
            CLOUDFLARED_ARCH="amd64"
        fi
        
        # Download and install cloudflared
        curl -L -o /tmp/cloudflared.deb \
            "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-${CLOUDFLARED_ARCH}.deb"
        sudo dpkg -i /tmp/cloudflared.deb
        rm /tmp/cloudflared.deb
        
        echo "‚úÖ cloudflared installed"
    fi
    
    echo ""
    echo "üåê Starting Cloudflare Tunnel..."
    echo "   This will create a temporary public URL for your GeoSight instance."
    echo ""
    echo "   Press Ctrl+C to stop the tunnel."
    echo ""
    
    cloudflared tunnel --url http://localhost:{{HTTP_PORT}}

# Run install and then run (full setup)
doit: install run

# Show container status
status:
    #!/usr/bin/env bash
    set -euo pipefail
    
    echo "üìä GeoSight Container Status:"
    echo ""
    if [ -d "{{GEOSIGHT_DIR}}" ]; then
        cd {{GEOSIGHT_DIR}}
        docker compose -f deployment/docker-compose.yml -f deployment/docker-compose.override.yml ps
    else
        echo "‚ö†Ô∏è  GeoSight-OS directory not found. Run 'just install' first."
    fi

# View logs
logs:
    #!/usr/bin/env bash
    set -euo pipefail
    
    if [ -d "{{GEOSIGHT_DIR}}" ]; then
        cd {{GEOSIGHT_DIR}}
        docker compose -f deployment/docker-compose.yml -f deployment/docker-compose.override.yml logs -f
    else
        echo "‚ö†Ô∏è  GeoSight-OS directory not found. Run 'just install' first."
    fi

# Access Django shell
shell:
    #!/usr/bin/env bash
    set -euo pipefail
    
    if [ -d "{{GEOSIGHT_DIR}}" ]; then
        cd {{GEOSIGHT_DIR}}
        make dev-shell
    else
        echo "‚ö†Ô∏è  GeoSight-OS directory not found. Run 'just install' first."
    fi
